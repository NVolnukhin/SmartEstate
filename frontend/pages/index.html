<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartEstate</title>
    <link href="https://fonts.googleapis.com/css2?family=MuseoModerno:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/logo.css">
    <link rel="stylesheet" href="../css/decorating.css">
    <link rel="stylesheet" href="../css/header_links.css">
    <link rel="stylesheet" href="../css/base_settings.css">
    <link rel="stylesheet" href="../css/pages/index.css">

</head>
<body>
    <div class="screen animated-bg">
        <div class="decor-circle circle-1"></div>
        <div class="decor-circle circle-2"></div>
        
        <div class="header">
            <a href="./index.html" class="logo">SmartEstate</a>
            <div class="auth-section">
                <!-- Для неавторизованных -->
                <div class="header-link">
                    <a href="./login.html" class="header-link">Войти</a>
                    <a href="./reg.html" class="header-link">Зарегистрироваться</a>
                </div>
                
                <!-- Для авторизованных -->
                <div class="profile-link-wrapper" style="display: none;">
                    <a href="./profile.html" class="profile-link">
                        <i class="fas fa-user"></i>
                        Профиль
                    </a>
                </div>
            </div>
        </div>
        
        <p class="hero-text">
            Наш сайт предоставляет возможность выбрать лучшую квартиру для вас. 
            Здесь вы можете сравнить все доступные квартиры в новостройках в 
            столице России - городе Москва. Для сравнения достаточно лишь выбрать 
            интересующие вас квартиры!
        </p>
        
        
        <div class="apartments-scroll">
            <div class="apartments-container" id="apartmentsContainer"></div>
        </div>

        <div class="developers-container">
            <div class="developer-card">
                <a href="./all_flats.html?page=1" class="developer-text">Просмотреть список всех квартир</a>

                <div class="arrow"></div>
            </div>
        </div>
    </div>

    <div class="dev-footer">
        <span class="dev-footer-text">Для разработчиков</span>
        <div class="dev-footer-dropdown">
          <a href="https://git.iu7.bmstu.ru/sgn3-prog/sgn3-prog-it-2025/ghostbusters" target="_blank">GitHub</a>
          <a href="./reports.html" target="_blank">Отчеты</a>
        </div>
    </div>

    
    <script type="module" src="../js/components/auth/token_сhecker.js"></script>
    <script src="../js/components/ui/profile_dropdown.js" defer></script>


    <script type="module">
        import { initTokenChecker, checkTokenExpiration } from '../js/components/auth/token_сhecker.js';

        document.addEventListener('DOMContentLoaded', function() {     
            initTokenChecker();

            function checkAuth() {
                return localStorage.getItem('authToken') !== null && checkTokenExpiration();
            }
            
            function updateUI() {
                if(checkAuth()) {
                    document.querySelector('.header-link').style.display = 'none';
                    document.querySelector('.profile-link-wrapper').style.display = 'block';
                } else {
                    document.querySelector('.header-link').style.display = 'flex';
                    document.querySelector('.profile-link-wrapper').style.display = 'none';
                }
            }
            
            updateUI();

            async function loadApartments() {
                try {
                    const response = await fetch('http://smartestate:5001/api/flats/random?count=10');
                    const apartments = await response.json();
                    
                    if (response.ok) {
                        renderApartments(apartments);
                    } else {
                        console.error('Ошибка загрузки квартир:', apartments.message);
                        renderError();
                    }
                } catch (error) {
                    console.error('Ошибка соединения:', error);
                    renderError();
                }
            }

            function renderApartments(apartments) {
                const container = document.getElementById('apartmentsContainer');
                container.innerHTML = '';
                
                apartments.forEach(apartment => {
                    const card = document.createElement('div');
                    card.className = 'apartment-card';
                    card.setAttribute('data-id', apartment.flatId);
                    
                    const formattedPrice = new Intl.NumberFormat('ru-RU', {
                        style: 'currency',
                        currency: 'RUB',
                        maximumFractionDigits: 0
                    }).format(apartment.price).replace('RUB', '₽');
                    
                    card.innerHTML = `
                        <div class="apartment-image">
                            ${apartment.mainImage ? 
                                `<img src="${apartment.mainImage}" alt="Квартира ${apartment.flatId}">` : 
                                `ЖК ${apartment.flatId}<br>${apartment.nearestMetro.name}`
                            }
                        </div>
                        <div class="apartment-price">
                            ${formattedPrice}
                            <button class="favorite-btn" data-id="${apartment.flatId}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        <div class="apartment-details">
                            <div class="apartment-name">ЖК "${apartment.residentialComplex}"</div>
                            <div class="apartment-metro">
                                <i class="fas fa-subway"></i>
                                ${apartment.nearestMetro.name} (${apartment.nearestMetro.minutesToMetro} мин)
                            </div>
                            <div>
                                ${apartment.roominess}-комнатная<br>
                                ${apartment.square} м²<br>
                                Этаж ${apartment.floor}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                document.querySelectorAll('.apartment-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (e.target.closest('.favorite-btn')) {
                            e.stopPropagation();
                            return;
                        }
                        
                        const apartmentId = this.getAttribute('data-id');
                        window.location.href = `./flat.html?id=${apartmentId}`;
                    });
                });
                
                initFavoriteButtons();
            }

            function renderError() {
                const container = document.getElementById('apartmentsContainer');
                container.innerHTML = `
                    <div style="color: #FFE4AA; text-align: center; width: 100%; padding: 20px;">
                        Не удалось загрузить список квартир. Пожалуйста, попробуйте позже.
                    </div>
                `;
            }

            function initFavoriteButtons() {
                const isAuth = checkAuth();
                
                // Загружаем избранное только для авторизованных
                if (isAuth) {
                    loadFavorites().then(favorites => {
                        console.log('Favorites loaded:', favorites); // В loadFavorites()
                        updateFavoriteIcons(favorites);
                    });
                }
                
                // Вешаем обработчики на все кнопки
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (!isAuth) {
                            window.location.href = './login.html'; // Перенаправляем на вход
                            return;
                        }
                        
                        const flatId = this.getAttribute('data-id');
                        const icon = this.querySelector('i');
                        
                        if (icon.classList.contains('fas')) {
                            // Удаляем из избранного
                            const success = await removeFromFavorites(flatId);
                            if (success) {
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                            }
                        } else {
                            // Добавляем в избранное
                            const success = await addToFavorites(flatId);
                            if (success) {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                            }
                        }
                    });
                });
            }            

            function updateFavoriteIcons(favorites) {
                console.log("Избранные ID:", favorites);
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    const flatId = btn.getAttribute('data-id');
                    const icon = btn.querySelector('i');
                    
                    if (favorites.includes(flatId)) {
                        icon.classList.replace('far', 'fas');
                    } else {
                        icon.classList.replace('fas', 'far');
                    }
                });
            }
            
            

            async function loadFavorites() {
                try {
                    const response = await fetch('http://smartestate:5001/api/user-preferences/favorites', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (!response.ok) {
                        console.error('Ошибка загрузки избранного:', await response.text());
                        return [];
                    }
            
                    const data = await response.json();
                    console.log("Ответ API (избранное):", data); // Для отладки
                    
                    // Упрощенная проверка, если API всегда возвращает массив объектов с flatId
                    if (Array.isArray(data)) {
                        return data.map(item => String(item.flatId));
                    }
                    
                    console.error('Неизвестный формат избранного:', data);
                    return [];
                } catch (error) {
                    console.error('Ошибка загрузки избранного:', error);
                    return [];
                }
            }

            async function addToFavorites(flatId) {
                try {
                    const response = await fetch('http://smartestate:5001/api/user-preferences/favorites', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({ flatId: parseInt(flatId) })
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('Ошибка добавления в избранное:', error);
                    return false;
                }
            }

            async function removeFromFavorites(flatId) {
                try {
                    const response = await fetch(`http://smartestate:5001/api/user-preferences/favorites/${flatId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('Ошибка удаления из избранного:', error);
                    return false;
                }
            }

            loadApartments();

            const cards = document.querySelectorAll('.developer-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 200);
                });
            });
            
            const screenElement = document.querySelector('.screen');
            let mouseX = 0;
            let mouseY = 0;
            
            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth - 0.5) * 30;
                mouseY = (e.clientY / window.innerHeight - 0.5) * 30;
                
                screenElement.style.backgroundPosition = `${50 + mouseX}% ${50 + mouseY}%`;
            });
        });
    </script>

</body>
</html>